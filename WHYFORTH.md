## 

## なぜにForth?、なぜにチャールズ・ムーア?

PLC試作からFORTH言語・処理系に興味が移り、この半年ほど大昔の文献を読み込んでいました。FORTH処理系の
* ワード定義を足してゆくことで機能を増やす。
* 他のワードの参照を並べて別のワードを作る。そのワードの実行とは、並べたワードを順に実行してゆくだけ。
* 並べたワードがポインタの配列となっており、間接参照先のコードを順に呼び出すだけという単純さ。
* 「コンパイル」は文字列を語に区切り、語を一つ一つ辞書(それまで定義した語のリスト)から探し出し、そのエントリのアドレスを順に参照してゆくだけ。なので、実行時に名前検索は発生しない。実行時にはポインタの2重参照だけ。
* 基本的な語は機械語ルーチンとして書く。

と、実行時の効率の良さと現代の意味での「コンパイル」とは異なるコンパイルの身軽さを好ましく思っていました。

そのなかで、FORTH発明者のチャールズ・ムーアの[文書](http://www.forth.org/POL.pdf)を読み、FORTHの背景にあるプログラミング哲学を知りました。1970年、今から50年前のコンピュータ環境の中で、いろんなマシンを渡り歩き信号処理・言語トランスレータ・惑星の軌道計算などさまざまなアプリケーションを開発してきた彼が最後にたどり着いたのがFORTH処理系だったのです。
* FORTRAN, Algol, Cobolはすでに存在したが、まだまだ性能の低いコンパイラ。
* カードデッキを計算機センターに持ち込み「実行」を依頼して結果が出てくると計算機センターに取りに行くと、預けたカードと実行結果のプリントアウトが出てくる。修正→実行が数10分単位になるまどろっこしさ。
* 仮想記憶も高速大容量ハードディスクもない。8kワードやら16kワードの「コア」とテレタイプと紙テープが自分で使えるコンピュータ。

彼の書いたものを見ると、以下のような叫びが聞こえてきました。
* コンパイラもOSも得体が知れない。実行効率もよいとは思えない。何をやっているのか分からないものに命を預けられるか！やるなら全部自分でやる。
* アプリケーションごとに最適な機能の集合は異なる。自分のアプリケーションを知らない他人が作ったライブラリは無駄も多い。
* 対話的に繰り返し試行することで理解が深まる。端末の前で繰り返し回数を稼いでゆく。
* Keep it Simple! 自分の問題の解決に集中し、あれにも使えるこれにも使えると汎用化を目指すな。汎用化の分だけ実行効率が落ち無駄がたまり、そのくせいざ別の用途に使おうとすると機能が足りない。それなら今作らずに必要な時に作ればよいのだ。

制限されたマシンの上で、FORTH処理系を一から組み上げてゆくことは楽しそうです。ASCIIART.BASとTiny StarTrekとはまた違う気分が味わえるに違いない。

FORTHが生まれた当時のプログラミングを体験する。FORTH立ち上げを経て体験する。
  * Mooreさんいわく、1968-70年当時は16kワード、パネルスイッチとランプだけでプログラミングを始たとのこと。
  * ターミナル(シリアル)、3コマンド(メモリ書き込み、ダンプ、RAM全体の保存)だけのモニタで機械語をメモリ上にならべるところから始める。
  * 最初は機械語サブルーチンを積み上げてゆく。
  * 単語の切り出し、ASCII数値変換、単語参照の列を順次実行(内部インタプリタ)
  * 行入力データから単語を切り出し、新しい単語エントリに別の単語を並べてゆく機能(コンパイラ)
  * 最終的には、加減乗除、辞書管理、定義語の定義と、FORTH言語ひとまとまりまで。

例によってPC上のエミュレータでは張り合いがない(私個人の気分の問題)。新しいCPUでSBCを作ろう。

* 8bit CPUでは面白くない、ちょっとしっかりした16bit CPUがよい。
* 手元にMC68008がある。機械語にも詳しくないので、この機会に勉強できて良いかな。
* 電脳伝説さんや奥江さんも精力的に基板作ってるし、それを真似しよう。
* 16kワード/32kBなら、PIC内蔵RAMだけでは足らんな。68k-MBC流にSRAMも追加して3チップとしよう。1MB SRAMが余っているからそれを使おう。ちょっと大きすぎるかもしれないが。

ということで、このリポジトリが含むSBCは以下の構成となります。

* CPU/RAM/シリアルIOで始める。どこかで外部ストレージ(SDカードかQuad FLASH)。
* RAMも最初は内蔵のみ6kバイトだけで始める。
* どこかのタイミングで128kB(1Mbit)SRAMを追加する。これで64kワードまでサポートできる。ちょっと大きすぎるけど、当時のコンピュータの雰囲気を出すことができるだろう。
* ソフトは電脳伝説さんのアレに簡易モニタ(メモリセット、ダンプ、シリアル経由で書き込み)、
* それとシングルステップ実行(余り分かっていないCPUなので、シングルステップ実行で体を慣らす)。

## 当時のコンピュータの雰囲気

1970年当時、私は小学生で吹田の万博を楽しみにしていました。もちろんコンピュータはバビル二世以上に分かっていません。中学高校でカードを打ち込んでカードデッキを作りFORTRANを動かすことはやったことがあります。百万遍の交差点でカードをばらまかせたことはありません。

* 16bitマシン
* 16kワード程度、これでも大きい方。
* パネルのスイッチでアドレス・データをセットしてスイッチを押してRAM(コア)に書き込む。
* ディスクはある。数MB程度のハードディスクと推察。
* ファイルシステムは存在しない、ブロックごとにデータを保存する。ブロック番号に何が入っているかをノートにメモして管理する感じ。

こんな環境を現在のSBCを使って再現する。

|1970年|現代|
|--|--|
|データを手で1バイトずつ打ち込む|モニタのSコマンドで1バイトずつRAMに書き込む
|RAMのデータを見る。アドレススイッチをパチパチしてデータ16bitをLEDで見る。|モニタのダンプコマンドで見る
|紙テープに書き出す|XMODEMか何かでTeraterm経由でRAMイメージをダウンロードする|
|紙テープからRAMにロード|XMODEMか何かでアップロード

当時は、アセンブラも簡単には使えなかったと思います。基本はハンドアセンブルだったのではないか。私はズルさせてもらい、PC側でアセンブラで機械語を作らせてもらうことにします。68000の機械語はまったく分かっていないので。

